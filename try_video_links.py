#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å°è¯•ä»APIåˆ†æä¸­å‘ç°çš„è§†é¢‘é“¾æ¥ä¸‹è½½è§†é¢‘
"""

import requests
import os
from pathlib import Path

def download_video_from_link(url, uid, sid, filename):
    """ä»æŒ‡å®šé“¾æ¥ä¸‹è½½è§†é¢‘"""
    session = requests.Session()
    
    # è®¾ç½®è®¤è¯å¤´
    token = f"{uid}-{sid}"
    headers = {
        'Authorization': f'Bearer {token}',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': '*/*',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Referer': 'https://metaso.cn/',
        'Origin': 'https://metaso.cn'
    }
    
    session.headers.update(headers)
    
    print(f"ğŸ” å°è¯•ä¸‹è½½: {url}")
    
    try:
        response = session.get(url, timeout=30, stream=True)
        print(f"   çŠ¶æ€ç : {response.status_code}")
        print(f"   Content-Type: {response.headers.get('Content-Type', 'unknown')}")
        
        if response.status_code == 200:
            content_type = response.headers.get('Content-Type', '')
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘æ–‡ä»¶
            if 'video/' in content_type or 'application/octet-stream' in content_type:
                print(f"   âœ… å‘ç°è§†é¢‘æ–‡ä»¶! Content-Type: {content_type}")
                
                # åˆ›å»ºä¸‹è½½ç›®å½•
                download_dir = Path("downloads")
                download_dir.mkdir(exist_ok=True)
                
                file_path = download_dir / filename
                
                # ä¸‹è½½æ–‡ä»¶
                with open(file_path, 'wb') as f:
                    for chunk in response.iter_content(chunk_size=8192):
                        if chunk:
                            f.write(chunk)
                
                file_size = os.path.getsize(file_path)
                print(f"   âœ… ä¸‹è½½å®Œæˆ: {file_path} ({file_size} bytes)")
                return True
            
            elif 'json' in content_type:
                # å¦‚æœæ˜¯JSONå“åº”ï¼Œæ‰“å°å†…å®¹
                try:
                    json_data = response.json()
                    print(f"   ğŸ“„ JSONå“åº”: {json_data}")
                    
                    # æ£€æŸ¥æ˜¯å¦åŒ…å«è§†é¢‘URL
                    if 'data' in json_data and isinstance(json_data['data'], dict):
                        if 'videoUrl' in json_data['data']:
                            video_url = json_data['data']['videoUrl']
                            print(f"   ğŸ¬ å‘ç°è§†é¢‘URL: {video_url}")
                            return download_video_from_link(video_url, uid, sid, filename)
                        elif 'url' in json_data['data']:
                            video_url = json_data['data']['url']
                            print(f"   ğŸ¬ å‘ç°URL: {video_url}")
                            return download_video_from_link(video_url, uid, sid, filename)
                    
                except Exception as e:
                    print(f"   âŒ JSONè§£æé”™è¯¯: {e}")
            
            else:
                print(f"   âš ï¸ æœªçŸ¥å†…å®¹ç±»å‹: {content_type}")
                # å°è¯•ä¿å­˜å‰1024å­—èŠ‚æŸ¥çœ‹å†…å®¹
                content_preview = response.content[:1024]
                print(f"   å†…å®¹é¢„è§ˆ: {content_preview}")
        
        else:
            print(f"   âŒ è¯·æ±‚å¤±è´¥: {response.status_code}")
            if response.text:
                print(f"   é”™è¯¯ä¿¡æ¯: {response.text[:200]}")
    
    except Exception as e:
        print(f"   âŒ è¯·æ±‚å¼‚å¸¸: {str(e)}")
    
    return False

def main():
    # ç”¨æˆ·è®¤è¯ä¿¡æ¯
    uid = "654ce6f986a91de24c79b52f"
    sid = "7db6149bc7944aff8fc5632fb5e91e75"
    
    # ä»APIåˆ†æä¸­å‘ç°çš„è§†é¢‘é“¾æ¥
    video_links = [
        "https://metaso.cn/api/ppt/8651522172447916032/video",
        "https://metaso.cn/api/chapter/8651523279591608320/video",
        "https://metaso.cn/api/export/8651522172447916032/video",
        "https://metaso.cn/api/generate/8651522172447916032/video",
        "https://metaso.cn/api/file/8651522172447916032/video",
        "https://metaso.cn/api/courseware/8651522172447916032/video"
    ]
    
    print("="*80)
    print("ğŸ¬ å°è¯•ä»å‘ç°çš„è§†é¢‘é“¾æ¥ä¸‹è½½è§†é¢‘")
    print(f"ğŸ” è®¤è¯ä¿¡æ¯: UID={uid[:10]}..., SID={sid[:10]}...")
    print("="*80)
    
    for i, link in enumerate(video_links, 1):
        print(f"\nğŸ“¹ å°è¯•é“¾æ¥ {i}/{len(video_links)}:")
        filename = f"metaso_video_{i}.mp4"
        
        success = download_video_from_link(link, uid, sid, filename)
        if success:
            print(f"\nğŸ‰ è§†é¢‘ä¸‹è½½æˆåŠŸï¼")
            break
        else:
            print(f"   âŒ æ­¤é“¾æ¥ä¸‹è½½å¤±è´¥")
    
    else:
        print(f"\nâŒ æ‰€æœ‰é“¾æ¥éƒ½ä¸‹è½½å¤±è´¥")
        print(f"\nğŸ’¡ å¯èƒ½çš„åŸå› :")
        print(f"   1. è§†é¢‘å°šæœªç”Ÿæˆå®Œæˆ")
        print(f"   2. éœ€è¦ç‰¹æ®Šçš„è¯·æ±‚æ–¹æ³•ï¼ˆPOSTè€Œä¸æ˜¯GETï¼‰")
        print(f"   3. è®¤è¯ä¿¡æ¯ä¸æ­£ç¡®æˆ–å·²è¿‡æœŸ")
        print(f"   4. APIæ¥å£éœ€è¦é¢å¤–å‚æ•°")

if __name__ == "__main__":
    main()